<!DOCTYPE html>
<html  lang="zh_CN">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
      <title>项目部署记录</title>
    
      <link rel="stylesheet" href="../_static/pygments.css">
      <link rel="stylesheet" href="../_static/theme.css">
      
      <script type="text/javascript" id="documentation_options" data-url_root="../" src="../_static/documentation_options.js"></script>

      <!-- sphinx script_files -->
        <script type="text/javascript" src="../_static/jquery.js"></script>
        <script type="text/javascript" src="../_static/underscore.js"></script>
        <script type="text/javascript" src="../_static/doctools.js"></script>
        <script type="text/javascript" src="../_static/language_data.js"></script>
        <script type="text/javascript" src="../_static/translations.js"></script>

      
      <script src="../_static/theme-vendors.js"></script>
      <script src="../_static/theme.js" defer></script>
    
  <link rel="index" title="索引" href="../genindex.html" />
  <link rel="search" title="搜索" href="../search.html" />
  <link rel="prev" title="环境要求" href="index.html" /> 
  </head>

  <body><div id="app" class="theme-container" :class="pageClasses"><navbar @toggle-sidebar="toggleSidebar">
  <router-link to="../index.html" class="home-link">
    
      <span class="site-name">monitoring</span>
    
  </router-link>

  <div class="links">
    <navlinks class="can-hide">



    </navlinks>
  </div>
</navbar>

      
      <div class="sidebar-mask" @click="toggleSidebar(false)">
      </div>
        <sidebar @toggle-sidebar="toggleSidebar">
          
          <navlinks>
            



            
          </navlinks><div id="searchbox" class="searchbox" role="search">
  <div class="caption"><span class="caption-text">快速搜索</span>
    <div class="searchformwrapper">
      <form class="search" action="../search.html" method="get">
        <input type="text" name="q" />
        <input type="submit" value="搜索" />
        <input type="hidden" name="check_keywords" value="yes" />
        <input type="hidden" name="area" value="default" />
      </form>
    </div>
  </div>
</div><div class="sidebar-links" role="navigation" aria-label="main navigation">
  
    <div class="sidebar-group">
      <p class="caption">
        <span class="caption-text"><a href="../contents.html#id1">目录</a></span>
      </p>
      <ul class="current">
        
          <li class="toctree-l1 "><a href="../main/index.html" class="reference internal ">项目设计</a>

            
          </li>

        
          <li class="toctree-l1 "><a href="../dev/index.html" class="reference internal ">开发文档</a>

            
          </li>

        
          <li class="toctree-l1 "><a href="index.html" class="reference internal ">环境要求</a>

            
          </li>

        
          <li class="toctree-l1 current"><a href="#" class="reference internal current">项目部署记录</a>

            
              <ul>
                
                  <li class="toctree-l2"><a href="#python" class="reference internal">第一步 python运行环境</a></li>
                
                  <li class="toctree-l2"><a href="#id2" class="reference internal">第二步 数据库准备与配置</a></li>
                
                  <li class="toctree-l2"><a href="#supervisord" class="reference internal">第三步 配置supervisord运行项目</a></li>
                
                  <li class="toctree-l2"><a href="#nginx" class="reference internal">第四步 配置nginx</a></li>
                
              </ul>
            
          </li>

        
      </ul>
    </div>
  
</div>
        </sidebar>

      <page>
          <div class="body-header" role="navigation" aria-label="navigation">
  
  <ul class="breadcrumbs">
    <li><a href="../index.html">Docs</a> &raquo;</li>
    
      <li><a href="../contents.html">目录</a> &raquo;</li>
    
      <li><a href="index.html">环境要求</a> &raquo;</li>
    
    <li>项目部署记录</li>
  </ul>
  

  <ul class="page-nav">
  <li class="prev">
    <a href="index.html"
       title="上一章">← 环境要求</a>
  </li>
</ul>
  
</div>
<hr>
          <div class="content" role="main">
            
  <div class="section" id="id1">
<h1>项目部署记录<a class="headerlink" href="#id1" title="永久链接至标题">¶</a></h1>
<p>项目结构如下:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>apudeMacBook-Pro:rd apuyuseng$ tree -L 2
.
├── BaiduShareSpider
│   ├── LICENSE
│   ├── __pycache__
│   ├── conf
│   ├── export.py
│   ├── export.sh
│   ├── login.py
│   ├── mail.py
│   ├── main.py
│   ├── models
│   ├── outmc.py
│   ├── pcloud.html
│   ├── requirements.txt
│   ├── screenshot
│   └── test_get_token.py
├── chromedriver
├── monitoring
│   ├── Dockerfile
│   ├── Dockerfile_base
│   ├── Dockerfile_web
│   ├── README.md
│   ├── asm
│   ├── assistant.py
│   ├── bin
│   ├── conf
│   ├── download
│   ├── env
│   ├── froala
│   ├── lib
│   ├── model
│   ├── monitoring.ini
│   ├── requirements.txt
│   ├── start.sh
│   ├── supervisord.conf
│   ├── supervisord.pid
│   ├── tasks
│   ├── view
│   ├── www
│   └── z
├── scrapyd
│   ├── Dockerfile
│   ├── LICENSE
│   ├── README.md
│   ├── requirements.txt
│   ├── scrapyd.conf
│   └── start.sh
└── supervisord.conf
</pre></div>
</div>
<div class="section" id="python">
<h2>第一步 python运行环境<a class="headerlink" href="#python" title="永久链接至标题">¶</a></h2>
<ol class="arabic">
<li><p>隔离运行环境:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ pip3 install virtualenv
$ virtualenv  --no-site-packages venv
</pre></div>
</div>
</li>
<li><p>安装第三方库:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ source ./venv/bin/activate
$ pip3 install -r monitoring/requirements.txt
$ pip3 install -r BaiduShareSpider/requirements.txt
$ pip3 install scrapyd w3lib requests Twisted==18.7.0
</pre></div>
</div>
</li>
</ol>
</div>
<div class="section" id="id2">
<h2>第二步 数据库准备与配置<a class="headerlink" href="#id2" title="永久链接至标题">¶</a></h2>
<ol class="arabic">
<li><p>创建数据库:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>(venv) apudeMacBook-Pro:rd apuyuseng$ psql
psql (11.3)
Type &quot;help&quot; for help.

apuyuseng=# CREATE USER apu PASSWORD &#39;yuyuan132&#39; CREATEDB;
apuyuseng=#CREATE DATABASE monitoring WITH ENCODING=&#39;UTF8&#39; OWNER=apu TEMPLATE=template1 CONNECTION LIMIT=-1;
</pre></div>
</div>
</li>
</ol>
<div class="admonition tip">
<p class="admonition-title">小技巧</p>
<p>这是创建数据库及分配权限</p>
<p>其中 <cite>apu</cite> 用户名 <cite>yuyuan132</cite> 是密码， <cite>monitoring</cite> 是数据库名，当然强烈建议更改，更改后请修改对应项目的数据库配置文件，一般的都会放在project/conf/base.toml,在配置文件中有相应的介绍。
数据库的相关设置和语法请查看postgresql。</p>
</div>
<ol class="arabic" start="2">
<li><p>创建项目表和导入系统默认数据:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ cd monitoring
$ python3 assistant.py schema
$ python3 assistant.py data
</pre></div>
</div>
</li>
</ol>
</div>
<div class="section" id="supervisord">
<h2>第三步 配置supervisord运行项目<a class="headerlink" href="#supervisord" title="永久链接至标题">¶</a></h2>
<p>详细配置请到supervisord官网查看
这里我们需要更改 <cite>directory</cite> 为我们相应项目路径</p>
<p>如我的:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="p">[</span><span class="n">supervisord</span><span class="p">]</span>
<span class="p">[</span><span class="n">supervisorctl</span><span class="p">]</span>
<span class="p">[</span><span class="n">inet_http_server</span><span class="p">]</span>
<span class="n">port</span> <span class="o">=</span> <span class="mf">0.0</span><span class="o">.</span><span class="mf">0.0</span><span class="p">:</span><span class="mi">9001</span>
<span class="n">username</span> <span class="o">=</span> <span class="n">admin</span>
<span class="n">password</span> <span class="o">=</span> <span class="n">admin</span>


<span class="p">[</span><span class="n">program</span><span class="p">:</span><span class="n">celery_worker</span><span class="p">]</span>
<span class="n">command</span><span class="o">=</span><span class="n">celery</span> <span class="o">-</span><span class="n">A</span> <span class="nb">bin</span><span class="o">.</span><span class="n">service</span><span class="o">.</span><span class="n">celery</span> <span class="n">worker</span> <span class="o">--</span><span class="n">loglevel</span><span class="o">=</span><span class="n">info</span>
<span class="n">directory</span><span class="o">=/</span><span class="n">Users</span><span class="o">/</span><span class="n">apuyuseng</span><span class="o">/</span><span class="n">rd</span><span class="o">/</span><span class="n">monitoring</span>
<span class="n">autorestart</span><span class="o">=</span><span class="n">true</span>
<span class="n">redirect_stderr</span><span class="o">=</span><span class="n">true</span>


<span class="p">[</span><span class="n">program</span><span class="p">:</span><span class="n">celery_beat</span><span class="p">]</span>
<span class="n">command</span><span class="o">=</span><span class="n">celery</span> <span class="o">-</span><span class="n">A</span> <span class="nb">bin</span><span class="o">.</span><span class="n">service</span><span class="o">.</span><span class="n">celery</span> <span class="n">beat</span> <span class="o">--</span><span class="n">loglevel</span><span class="o">=</span><span class="n">info</span>
<span class="n">directory</span><span class="o">=/</span><span class="n">Users</span><span class="o">/</span><span class="n">apuyuseng</span><span class="o">/</span><span class="n">rd</span><span class="o">/</span><span class="n">monitoring</span>
<span class="n">autorestart</span><span class="o">=</span><span class="n">true</span>
<span class="n">redirect_stderr</span><span class="o">=</span><span class="n">true</span>


<span class="p">[</span><span class="n">program</span><span class="p">:</span><span class="n">monitoring</span><span class="p">]</span>
<span class="n">command</span><span class="o">=</span><span class="n">gunicorn</span> <span class="o">--</span><span class="n">workers</span><span class="o">=</span><span class="mi">8</span> <span class="o">--</span><span class="n">log</span><span class="o">-</span><span class="n">level</span><span class="o">=</span><span class="n">error</span> <span class="o">--</span><span class="n">bind</span><span class="o">=</span><span class="mf">0.0</span><span class="o">.</span><span class="mf">0.0</span><span class="p">:</span><span class="mi">8000</span> <span class="o">-</span><span class="n">k</span> <span class="n">flask_sockets</span><span class="o">.</span><span class="n">worker</span> <span class="nb">bin</span><span class="o">.</span><span class="n">service</span><span class="o">.</span><span class="n">wsgi</span><span class="p">:</span><span class="n">app</span>
<span class="n">directory</span><span class="o">=/</span><span class="n">Users</span><span class="o">/</span><span class="n">apuyuseng</span><span class="o">/</span><span class="n">rd</span><span class="o">/</span><span class="n">monitoring</span>
<span class="n">autorestart</span><span class="o">=</span><span class="n">true</span>
<span class="n">redirect_stderr</span><span class="o">=</span><span class="n">true</span>

<span class="p">[</span><span class="n">program</span><span class="p">:</span><span class="n">chromedriver</span><span class="p">]</span>
<span class="n">command</span><span class="o">=./</span><span class="n">chromedriver</span> <span class="o">--</span><span class="n">whitelisted</span><span class="o">-</span><span class="n">ips</span> <span class="o">--</span><span class="n">log</span><span class="o">-</span><span class="n">level</span><span class="o">=</span><span class="n">INFO</span>
<span class="n">autostart</span><span class="o">=</span><span class="n">true</span>
<span class="n">autorestart</span><span class="o">=</span><span class="n">true</span>

<span class="p">[</span><span class="n">program</span><span class="p">:</span><span class="n">BaiduShareSpider</span><span class="p">]</span>
<span class="n">command</span><span class="o">=</span><span class="n">python3</span> <span class="n">main</span><span class="o">.</span><span class="n">py</span>
<span class="n">directory</span><span class="o">=/</span><span class="n">Users</span><span class="o">/</span><span class="n">apuyuseng</span><span class="o">/</span><span class="n">rd</span><span class="o">/</span><span class="n">BaiduShareSpider</span>
<span class="n">autostart</span><span class="o">=</span><span class="n">true</span>
<span class="n">autorestart</span><span class="o">=</span><span class="n">true</span>

<span class="p">[</span><span class="n">program</span><span class="p">:</span><span class="n">scrapyd</span><span class="p">]</span>
<span class="n">command</span><span class="o">=</span><span class="n">scrapyd</span>
<span class="n">autostart</span><span class="o">=</span><span class="n">true</span>
<span class="n">autorestart</span><span class="o">=</span><span class="n">true</span>
</pre></div>
</div>
<div class="admonition tip">
<p class="admonition-title">小技巧</p>
<p>supervisord的配置不止这么简单</p>
<p>可以根据需求设置日志的存储、重试次数等。</p>
</div>
<p><strong>运行</strong> :在终端直接执行 <cite>supervisord</cite>
访问 <a class="reference external" href="http://127.0.0.1:9001">http://127.0.0.1:9001</a>
登陆账号密码是 <cite>admin</cite> ，这个在上述配置中可以配置的</p>
<img alt="../_images/supervisord.png" src="../_images/supervisord.png" />
</div>
<div class="section" id="nginx">
<h2>第四步 配置nginx<a class="headerlink" href="#nginx" title="永久链接至标题">¶</a></h2>
<p>可以通过 <cite>nginx -t</cite> 知道配置文件路径 <cite>/usr/local/etc/nginx/nginx.conf</cite></p>
<p>我的配置文件如下:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>server {
    listen       80;
    server_name  localhost;

    #charset koi8-r;

    #access_log  logs/host.access.log  main;
    access_log  /var/log/nginx/monitoring.access.log;
    error_log  /var/log/nginx/monitoring.error.log;
    location /project/baidu_spider/run {
         proxy_pass http://0.0.0.0:8000/project/baidu_spider/run;
         proxy_http_version 1.1;
         proxy_set_header Upgrade $http_upgrade;
         proxy_set_header Connection &quot;upgrade&quot;;

    }

    location / {
           proxy_pass http://0.0.0.0:8000/;
           proxy_set_header Host $host;
           proxy_set_header X-Real-IP $remote_addr;
           proxy_set_header REMOTE-HOST $remote_addr;
           proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    }
    location /res/ {
        alias /Users/apuyuseng/rd/monitoring/www/;
        rewrite ^(.*)\.md5_[^.]*\.(css|js)$ $1.$2 last;

    }
}
</pre></div>
</div>
<p>其中将路径修改成项目路径</p>
<div class="admonition tip">
<p class="admonition-title">小技巧</p>
<p>nginx是方向代理的好帮手</p>
<p>nginx配置很强大、可以根据需求配置、如日志、缓存、限制ip、登陆等等，若需要请到官网查看相应配置。</p>
</div>
<p>到此部署已经完成。😄</p>
</div>
</div>


          </div>
          <div class="page-nav">
            <div class="inner"><ul class="page-nav">
  <li class="prev">
    <a href="index.html"
       title="上一章">← 环境要求</a>
  </li>
</ul><div class="footer" role="contentinfo">
      &#169; 版权所有 2019, apuyuseng.
    <br>
    Created using <a href="http://sphinx-doc.org/">Sphinx</a> 2.0.1 with <a href="https://github.com/schettino72/sphinx_press_theme">Press Theme</a>.
</div>
            </div>
          </div>
      </page>
  </div></body>
</html>